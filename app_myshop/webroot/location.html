<?php 
define("API_KEY","AIzaSyDn1JrKoNqygrc0Wjei_wpPCSFIJXvvclk") ?>
<html>
<head>
<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Location</title>
</head>
<style>
body {
	font-family :Arial;
}
#map-layer {
	margin: 20px 0px;
	max-width: 600px;
	min-height: 400;
}
#btnAction {
	background: #3878c7;
    padding: 10px 40px;
    border: #3672bb 1px solid;
    border-radius: 2px;
    color: #FFF;
    font-size: 0.9em;
    cursor:pointer;
    display:block;
}
#btnAction:disabled {
    background: #6c99d2;
}
</style>
<body>
<h1>Google Map Javascript API</h1>
	<div id="button-layer"><button id="btnAction" onClick="locate()">Use My Current Location</button></div>
	<br><br>
	<div>Drag the marker on the map to set your delivery location</div>
	<div id="map-layer"></div>

	<script
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDPw4JwipzdiSkAGMWf_RMDMiinl88v_p8&callback=initMap"
		async defer></script>
	<script type="text/javascript">
	var map;
	var geocoder;
	var infoWindow;
	var defaultLat = 17.6140;
	var defaultLng = 78.0816;
	var defaultAddress = "Sangareddy";
	var zoomLevel = 15;
	
	function initMap() {
		let mapLayer = document.getElementById("map-layer");
		let centerCoordinates = new google.maps.LatLng(defaultLat, defaultLng);
		let defaultOptions = { center: centerCoordinates, zoom: zoomLevel }		

		map = new google.maps.Map(mapLayer, defaultOptions);
		
		let position = {
			coords: {
				latitude: defaultLat,
				longitude: defaultLng,
			}
		};
		
		positionSuccess(position);
	}

	function locate(){		
		if ("geolocation" in navigator){			
			let options = {timeout:60000}; // timeout at 60,0000 milliseconds (60 seconds)			
			navigator.geolocation.getCurrentPosition(positionSuccess, positionError, options);
		} else {
			alert('Your device does not support Geolocation feature. Please drag the marker on the map to your preferred location.');
		}
	}
	
	function positionSuccess(position) { 
		let currentLatitude = position.coords.latitude;
		let currentLongitude = position.coords.longitude;		
		let currentLocation = { lat: currentLatitude, lng: currentLongitude };
		
		
		infoWindow = new google.maps.InfoWindow();
		geocoder = new google.maps.Geocoder();
		
		map = new google.maps.Map(document.getElementById("map-layer"), {
		  zoom: zoomLevel,
		  center: currentLocation,
		});
		// The marker, positioned at currentLocation
		const marker = new google.maps.Marker({
		  position: currentLocation,
		  map: map,
		  draggable: true,
		  animation: google.maps.Animation.DROP
		});
		
		const data = {
			description: defaultAddress
		};
		
		(function (marker, data) {
			google.maps.event.addListener(marker, "click", function (e) {
				infoWindow.setContent(data.description);
				infoWindow.open(map, marker);
			});
			google.maps.event.addListener(marker, "dragend", function (e) {
				var lat, lng, address;
				geocoder.geocode({ 'latLng': marker.getPosition() }, function (results, status) {
					if (status == google.maps.GeocoderStatus.OK) {
						lat = marker.getPosition().lat();
						lng = marker.getPosition().lng();
						address = results[0].formatted_address;
						
						data = {
							description: address
						};
						
						infoWindow.setContent(data.description);
						
						updateCustomerLocation(lat, lng, address);
					}
				});
			});
		})(marker, data);
	}
	
	function positionError(error) {
		let msg = "Network error.";
		console.log("error.message = " + error.message);  
		
		switch (error.code) {
			case error.PERMISSION_DENIED:
				msg = "Geolocation is not enabled. Please enable to use this feature.";
				break;
			case error.POSITION_UNAVAILABLE:
				msg = "Can't determine your location.";
				break;
			case error.TIMEOUT:
				msg = "The request for geolocation information timed out.";
				break;
			case error.UNKNOWN_ERROR:
				msg = "An unknown error occurred.";
				break;  
		}
		alert(msg);
	}
	
	function updateCustomerLocation(lat, lng, address) {
		console.log('lat', lat);
		console.log('lng', lng);
		console.log('address', address);
	}
	</script>
</body>
</html>